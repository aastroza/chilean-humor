# Clip Curation Interface

An interactive web interface for curating the Chilean Humor audio clips dataset. This interface allows you to review, edit, and select clips for your final dataset.

## Features

### Core Functionalities

1. **Audio Playback**: Play each audio clip directly in the browser
2. **Transcript Editing**: Edit transcription text inline with auto-save
3. **Clip Selection**: Include or exclude clips from the final dataset
4. **Auto-Save**: All changes are saved to disk immediately
5. **Search & Filter**: Search transcripts and filter by selection status
6. **Bulk Actions**: Select or deselect all clips at once
7. **Export**: Generate a curated dataset with only selected clips

## Prerequisites

### Install Dependencies

```bash
pip install streamlit
```

Or install all project dependencies:

```bash
pip install -r requirements.txt
```

### Generate Clips

Before using the curation interface, you need to generate the clips:

```bash
python3 process_clips.py
```

This will create:
- `./audios/` - Directory with audio clips
- `./clips_metadata.json` - Metadata file with clip information

## Usage

### Starting the Interface

Launch the Streamlit interface:

```bash
streamlit run curate_clips.py
```

The interface will automatically open in your default web browser at `http://localhost:8501`.

### Interface Overview

#### Main View

The main view displays clips with:
- **Checkbox**: Include/exclude clip from final dataset (left column)
- **Clip Header**: Filename, routine ID, duration, and time range
- **Audio Player**: Play button to listen to the clip
- **Transcript Editor**: Editable text area for the transcription

#### Sidebar - Statistics

The sidebar shows:
- **Total Clips**: Total number of clips in the dataset
- **Selected Clips**: Number of clips marked for inclusion
- **Excluded Clips**: Number of clips marked for exclusion

#### Sidebar - Settings

- **Clips per page**: Choose how many clips to display per page (5, 10, 20, 50, or 100)

#### Sidebar - Filters

- **Show only selected clips**: Display only clips marked for inclusion
- **Search in transcripts**: Filter clips containing specific text

#### Sidebar - Export

- **Export Selected Clips**: Generate `clips_metadata_curated.json` with only selected clips

#### Sidebar - Bulk Actions

- **Select All**: Mark all clips for inclusion
- **Deselect All**: Mark all clips for exclusion

### Navigation

Use the pagination controls at the top:
- **⏮️ First**: Jump to first page
- **◀️ Prev**: Go to previous page
- **Page X of Y**: Current page indicator
- **Next ▶️**: Go to next page
- **Last ⏭️**: Jump to last page

## Working with the Interface

### Selecting/Deselecting Clips

1. Click the checkbox next to any clip to include/exclude it
2. Changes are saved immediately
3. The clip status emoji changes:
   - ✅ = Included in dataset
   - ❌ = Excluded from dataset

### Editing Transcripts

1. Click in the transcript text area
2. Make your edits
3. Click outside the text area or press Tab
4. Changes are automatically saved to `clips_metadata.json`

### Searching for Specific Content

1. Go to the sidebar
2. Enter search terms in "Search in transcripts"
3. Only clips containing the search term will be displayed
4. Clear the search box to see all clips again

### Filtering Selected/Excluded Clips

1. Check "Show only selected clips" in the sidebar
2. Only clips marked for inclusion will be shown
3. Uncheck to see all clips again

### Exporting the Final Dataset

1. Review and curate your clips using the interface
2. Click "Export Selected Clips" in the sidebar
3. A new file `clips_metadata_curated.json` will be created
4. This file contains only the clips you've selected

## File Structure

### Input Files

- `clips_metadata.json` - Original metadata file (generated by `process_clips.py`)
- `audios/` - Directory containing audio clip files

### Output Files

- `clips_metadata.json` - Updated with your selections and edits (auto-saved)
- `clips_metadata_curated.json` - Exported file with only selected clips

### Metadata Format

Each clip entry contains:

```json
{
  "audio_path": "./audios/routine_24_clip_000001.mp3",
  "transcript": "Text of the transcription",
  "routine_id": 24,
  "start_time": 0.0,
  "end_time": 25.0,
  "duration": 25.0,
  "selected": true
}
```

Fields:
- `audio_path`: Path to the audio file
- `transcript`: Transcription text (editable)
- `routine_id`: ID of the source routine
- `start_time`: Start time in the original video (seconds)
- `end_time`: End time in the original video (seconds)
- `duration`: Duration of the clip (seconds)
- `selected`: Whether clip is included in final dataset (boolean)

## Tips & Best Practices

### Efficient Curation Workflow

1. **First Pass**: Use pagination to quickly go through all clips
   - Listen to each clip
   - Deselect any clips with audio quality issues or irrelevant content

2. **Second Pass**: Use search to find specific content
   - Search for keywords or phrases
   - Review and edit transcripts for accuracy

3. **Final Review**: Filter to show only selected clips
   - Do a final quality check
   - Ensure transcripts are accurate

4. **Export**: Generate the final curated dataset

### Keyboard Shortcuts

While Streamlit doesn't have many keyboard shortcuts, you can:
- **Tab**: Move between transcript fields
- **Ctrl+F** (browser): Search within the page
- **F5**: Refresh the page if needed

### Performance Tips

- If you have many clips (1000+), use smaller "Clips per page" values (10-20)
- Use search and filters to work on subsets of the data
- The interface auto-saves, so you can close and reopen without losing work

## Troubleshooting

### Audio files not playing

- Ensure the `audios/` directory exists
- Check that audio file paths in `clips_metadata.json` are correct
- Verify audio files are in MP3 format

### Interface is slow

- Reduce "Clips per page" to 5 or 10
- Close other browser tabs
- Check your system resources

### Changes not saving

- Check file permissions on `clips_metadata.json`
- Ensure you have write access to the directory
- Look for error messages in the terminal running Streamlit

### "Metadata file not found" error

- Run `python3 process_clips.py` first to generate clips
- Ensure `clips_metadata.json` exists in the project directory

## Advanced Usage

### Custom Metadata File

To use a different metadata file, edit `curate_clips.py`:

```python
METADATA_FILE = './custom_metadata.json'
```

### Adding Custom Fields

You can extend the metadata structure by:
1. Adding fields to the JSON manually or programmatically
2. Modifying `curate_clips.py` to display and edit those fields

### Batch Processing

To programmatically select/deselect clips based on criteria:

```python
import json

# Load metadata
with open('clips_metadata.json', 'r') as f:
    clips = json.load(f)

# Example: Deselect clips shorter than 5 seconds
for clip in clips:
    if clip['duration'] < 5:
        clip['selected'] = False

# Save
with open('clips_metadata.json', 'w') as f:
    json.dump(clips, f, ensure_ascii=False, indent=2)
```

## Integration with ML Pipelines

The curated dataset can be used for:

### Speech Recognition Training

```python
import json

# Load curated clips
with open('clips_metadata_curated.json', 'r') as f:
    clips = json.load(f)

# Create training dataset
for clip in clips:
    audio_path = clip['audio_path']
    transcript = clip['transcript']
    # Use audio_path and transcript for ASR training
```

### Data Analysis

```python
import pandas as pd

# Convert to DataFrame
df = pd.read_json('clips_metadata_curated.json')

# Analyze
print(f"Total duration: {df['duration'].sum() / 60:.1f} minutes")
print(f"Average clip length: {df['duration'].mean():.1f} seconds")
print(f"Routines included: {df['routine_id'].nunique()}")
```

## Support

If you encounter issues:

1. Check the terminal running Streamlit for error messages
2. Verify all prerequisites are installed
3. Ensure `clips_metadata.json` exists and is valid JSON
4. Review this documentation for troubleshooting steps

## Related Scripts

- `process_clips.py` - Generate clips from transcripts
- `process_clips_test.py` - Test clip processing on a sample

See `CLIP_PROCESSING_README.md` for more information on clip generation.
